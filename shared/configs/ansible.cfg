# Ansible Configuration for Homelab Infrastructure
# This configuration uses the dynamic inventory system and environment-first structure

[defaults]
# Use dynamic inventory script
inventory = $SHARED_DIR_PATH/../environments/dev/ansible, $SHARED_DIR_PATH/../environments/prod/ansible


# Host key checking
host_key_checking = False

# SSH configuration
ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no
pipelining = True
timeout = 30

# # Output configuration
# stdout_callback = yaml
# bin_ansible_callbacks = True

# Logging
# log_path = ./ansible.log
# Performance settings
forks = 10
gathering = smart
fact_caching = memory
fact_caching_timeout = 86400

# Role and collection paths
roles_path = $SHARED_DIR_PATH/ansible/roles:environments/{{ env | default('dev') }}/ansible/roles
collections_path = $SHARED_DIR_PATH/ansible/collections
playbook_dir = $SHARED_DIR_PATH/ansible/playbooks

# Variable precedence
vars_plugins_enabled = host_group_vars, community.sops.sops
variable_precedence = inventory_dir, inventory_file, inventory_script, inventory_dir_plugins, playbook_dir, playbook_dir_plugins

# Environment-specific settings
[inventory:shared/ansible/inventory/dynamic_inventory.py]
# Dynamic inventory script settings
env_var = ANSIBLE_ENVIRONMENT
debug_var = ANSIBLE_DEBUG

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False

[ssh_connection]
ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no
pipelining = True
control_path = /tmp/ansible-ssh-%%h-%%p-%%r
retries = 3

; [galaxy]
; roles_path = shared/ansible/roles
; collections_path = shared/ansible/collections

[colors]
highlight = white
verbose = blue
warn = bright purple
error = red
debug = dark gray
deprecate = purple
skip = cyan
unreachable = red
ok = green
changed = yellow
diff_add = green
diff_remove = red
diff_lines = cyan

# Plugin configuration
[callback_plugins]
callback_plugins = $SHARED_DIR_PATH/ansible/plugins/callback

[filter_plugins]
filter_plugins = $SHARED_DIR_PATH/ansible/plugins/filter

[lookup_plugins]
lookup_plugins = $SHARED_DIR_PATH/ansible/plugins/lookup

[action_plugins]
action_plugins = $SHARED_DIR_PATH/ansible/plugins/action

# Environment-specific configuration
[env:dev]
# Development environment settings
inventory = $SHARED_DIR_PATH/ansible/inventory/dynamic_inventory.py
extra_vars = @environments/dev/ansible/group_vars/dev/main.yaml

[env:staging]
# Staging environment settings
inventory = $SHARED_DIR_PATH/ansible/inventory/dynamic_inventory.py
extra_vars = @environments/staging/ansible/group_vars/staging/main.yaml

[env:prod]
# Production environment settings
inventory = $SHARED_DIR_PATH/ansible/inventory/dynamic_inventory.py
extra_vars = @environments/prod/ansible/group_vars/prod/main.yaml

[inventory]
enable_plugins = host_list, script, auto, yaml, ini, toml

[community.sops]
age_keyfile = ~/.config/sops/age/keys.txt
valid_extensions = .sops.yml, .sops.yaml, .sops.json
config_path = $SHARED_DIR_PATH/configs/sops.yaml
cache = true
stage = inventory