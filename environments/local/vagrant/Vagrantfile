# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrant configuration for deploying Proxmox VE from Packer template

Vagrant.configure("2") do |config|
  # Disable Vagrant's fstab modification (synced folders disabled anyway)
  config.vm.allow_fstab_modification = false
  # Disable NFS - we don't use synced folders for Proxmox
  config.nfs.functional = false
  # SSH: connect as root (Proxmox uses root, no vagrant user)
  config.ssh.username = "root"
  # Do not use sudo when running commands over SSH (we are already root)
  config.ssh.sudo_command = "%c"
  # Key path injected by deploy.sh via VAGRANT_SSH_PRIVATE_KEY (must match Packer build keys)
  config.ssh.insert_key = true
  if ENV["VAGRANT_SSH_PRIVATE_KEY"]
    key_path = File.expand_path(ENV["VAGRANT_SSH_PRIVATE_KEY"])
    config.ssh.private_key_path = key_path if File.exist?(key_path)
  end
  config.ssh.password = "vagrantvagrant"
  config.vm.define "pve02" do |pve|
    # VM IP on homelab-local (must match deploy.sh DHCP host and host_vars ansible_host)
    PVE_IP = "192.168.56.149"
    pve_ssh_ip = (ENV["VAGRANT_PROXMOX_IP"] || PVE_IP).to_s.strip
    pve_ssh_ip = PVE_IP if pve_ssh_ip.empty?
    # Force IP only: avoid getaddrinfo "Name or service not known" if hostname was passed
    pve_ssh_ip = PVE_IP unless pve_ssh_ip =~ /^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/
    pve.ssh.host = pve_ssh_ip
    pve.vm.boot_timeout = 120

    # homelab-local: deploy.sh creates this and assigns PVE_IP via DHCP. Don't overwrite guest config.
    pve.vm.network :private_network,
      ip: PVE_IP,
      libvirt__network_name: "homelab-local",
      libvirt__ip_address: PVE_IP,
      libvirt__mac: "52:54:00:00:56:49",
      auto_config: false

    # Use the Packer-built template
    pve.vm.box = "proxmox-pve02-local"
    
    pve.vm.allow_fstab_modification = false
    # Disable synced folder (Proxmox doesn't need it)
    pve.vm.synced_folder ".", "/vagrant", disabled: true

    # Provider-specific configuration for libvirt (KVM)
    pve.vm.provider "libvirt" do |libvirt|
      # Use system session for proper network access
      libvirt.qemu_use_session = false

      # VM resources
      libvirt.memory = 20480  # 20GB RAM
      libvirt.cpus = 8        # 8 CPU cores

      # Enable nested virtualization (required for Proxmox to run VMs)
      libvirt.nested = true
      libvirt.cpu_mode = "host-passthrough"

      # Graphics and video
      libvirt.graphics_type = "spice"
      libvirt.video_type = "qxl"
      libvirt.video_vram = 16384

      # Disk and NIC settings
      libvirt.nic_model_type = "virtio"
      libvirt.disk_bus = "virtio"

      # Second disk for ZFS storage pool (01-zfs-setup.yml)
      libvirt.storage :file, :size => "100G", :type => "raw"

      # Management NIC: so "Waiting for domain to get an IP" finishes. SSH uses pve.ssh.host above.
      # Use distinct MAC so both NICs differ (homelab-local uses 52:54:00:00:56:50 below).
      libvirt.management_network_name = "vagrant-libvirt"
      libvirt.management_network_address = "192.168.121.0/24"
      libvirt.management_network_mac = "52:54:00:00:56:50"
    end
    # If "Waiting for domain to get an IP" never ends, VM may have only one NIC. Run: vagrant destroy -f && vagrant up

    # Show access info after boot
    pve.vm.provision "shell", name: "display-info", run: "always", inline: <<-SHELL
      echo ""
      echo "Proxmox VE: https://#{PVE_IP}:8006 (root / vagrantvagrant)"
      echo "SSH: vagrant ssh"
      echo ""
    SHELL
  end
end
