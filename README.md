# Homelab Infrastructure

This repository contains the complete infrastructure-as-code setup for a multi-cluster Kubernetes homelab running on Proxmox with Talos Linux and Flux GitOps.

> **Note**: All commands in this documentation assume you're running from the repository root directory.

## üèóÔ∏è Architecture Overview

- **Infrastructure**: Proxmox VE hypervisors
- **Orchestration**: Talos Linux + Kubernetes
- **GitOps**: Flux CD
- **Provisioning**: Terraform
- **Configuration**: Ansible
- **Clusters**: Development, Staging, Production

## üìÅ Folder Structure

```
homelab/
‚îú‚îÄ‚îÄ .github/                          # GitHub workflows and templates
‚îÇ   ‚îú‚îÄ‚îÄ workflows/                    # CI/CD pipelines
‚îÇ   ‚îú‚îÄ‚îÄ ISSUE_TEMPLATE/              # Issue templates
‚îÇ   ‚îî‚îÄ‚îÄ PULL_REQUEST_TEMPLATE/       # PR templates
‚îú‚îÄ‚îÄ clusters/                         # Kubernetes cluster configurations
‚îÇ   ‚îú‚îÄ‚îÄ dev/                         # Development cluster
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ talos/                   # Talos Linux configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ control-plane/       # Control plane node configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ worker/              # Worker node configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ configs/             # Cluster-specific configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ flux/                    # Cluster-specific Flux GitOps configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap/           # Flux bootstrap for this cluster
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ apps/                # Applications deployed to this cluster
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/      # Infrastructure for this cluster
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring/          # Monitoring stack for this cluster
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ apps/                    # Application configurations
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ monitoring/          # Monitoring applications
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ networking/          # CNI and networking
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ storage/             # Storage solutions
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ security/            # Security tools
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ platform/            # Platform services
‚îÇ   ‚îú‚îÄ‚îÄ staging/                     # Staging cluster (same structure as dev)
‚îÇ   ‚îî‚îÄ‚îÄ prod/                        # Production cluster (same structure as dev)
‚îú‚îÄ‚îÄ configs/                         # Configuration files
‚îÇ   ‚îú‚îÄ‚îÄ proxmox/                     # Proxmox configurations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodes/                   # Node-specific configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pve01/              # Proxmox node 1 configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pve02/              # Proxmox node 2 configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pve03/              # Proxmox node 3 configs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/               # Configuration templates
‚îÇ   ‚îú‚îÄ‚îÄ talos/                       # Talos Linux configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/               # Talos configuration templates
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ patches/                 # Configuration patches
‚îÇ   ‚îú‚îÄ‚îÄ flux/                        # Global Flux templates and common configs
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/               # Flux configuration templates
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ common-apps/             # Common applications across clusters
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ infrastructure/          # Common infrastructure components
‚îÇ   ‚îî‚îÄ‚îÄ secrets/                     # Encrypted secrets
‚îÇ       ‚îú‚îÄ‚îÄ encrypted/               # Encrypted secret files
‚îÇ       ‚îî‚îÄ‚îÄ keys/                    # Encryption keys
‚îú‚îÄ‚îÄ docs/                            # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ architecture/                # Architecture documentation
‚îÇ   ‚îú‚îÄ‚îÄ deployment/                  # Deployment guides
‚îÇ   ‚îú‚îÄ‚îÄ operations/                  # Operational procedures
‚îÇ   ‚îî‚îÄ‚îÄ troubleshooting/             # Troubleshooting guides
‚îú‚îÄ‚îÄ infrastructure/                  # Infrastructure as Code
‚îÇ   ‚îú‚îÄ‚îÄ proxmox/                     # Proxmox configurations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nodes/                   # Node configurations
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pve01/              # Node 1 specific configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pve02/              # Node 2 specific configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pve03/              # Node 3 specific configs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates/               # Configuration templates
‚îÇ   ‚îú‚îÄ‚îÄ terraform/                   # Terraform configurations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ environments/            # Environment-specific configs
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dev/                # Development environment
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ staging/            # Staging environment
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prod/               # Production environment
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modules/                 # Reusable Terraform modules
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ proxmox-vm/         # Proxmox VM module
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ talos-cluster/      # Talos cluster module
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network/            # Network module
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ global/                  # Global Terraform configs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ workspaces/              # Terraform workspaces
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ dev/                # Dev workspace
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ staging/            # Staging workspace
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ prod/               # Production workspace
‚îÇ   ‚îî‚îÄ‚îÄ ansible/                     # Ansible playbooks
‚îÇ       ‚îú‚îÄ‚îÄ inventory/               # Ansible inventory
‚îÇ       ‚îú‚îÄ‚îÄ playbooks/               # Ansible playbooks
‚îÇ       ‚îú‚îÄ‚îÄ roles/                   # Ansible roles
‚îÇ       ‚îú‚îÄ‚îÄ group_vars/              # Group variables
‚îÇ       ‚îî‚îÄ‚îÄ host_vars/               # Host variables
‚îú‚îÄ‚îÄ scripts/                         # Automation scripts
‚îÇ   ‚îú‚îÄ‚îÄ proxmox/                     # Proxmox management scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ setup/                   # Setup scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ maintenance/             # Maintenance scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ backup/                  # Backup scripts
‚îÇ   ‚îú‚îÄ‚îÄ terraform/                   # Terraform helper scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ helpers/                 # Helper scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ validation/              # Validation scripts
‚îÇ   ‚îú‚îÄ‚îÄ talos/                       # Talos management scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap/               # Bootstrap scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ upgrade/                 # Upgrade scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ maintenance/             # Maintenance scripts
‚îÇ   ‚îú‚îÄ‚îÄ flux/                        # Flux management scripts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ bootstrap/               # Bootstrap scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ deploy/                  # Deployment scripts
‚îÇ   ‚îî‚îÄ‚îÄ utils/                       # Utility scripts
‚îÇ       ‚îú‚îÄ‚îÄ common/                  # Common utilities
‚îÇ       ‚îú‚îÄ‚îÄ monitoring/              # Monitoring utilities
‚îÇ       ‚îî‚îÄ‚îÄ backup/                  # Backup utilities
‚îú‚îÄ‚îÄ tools/                           # Development and operational tools
‚îÇ   ‚îú‚îÄ‚îÄ monitoring/                  # Monitoring tools
‚îÇ   ‚îú‚îÄ‚îÄ backup/                      # Backup tools
‚îÇ   ‚îú‚îÄ‚îÄ security/                    # Security tools
‚îÇ   ‚îî‚îÄ‚îÄ validation/                  # Validation tools
‚îú‚îÄ‚îÄ secrets/                         # Secret management
‚îÇ   ‚îú‚îÄ‚îÄ encrypted/                   # Encrypted secrets
‚îÇ   ‚îú‚îÄ‚îÄ keys/                        # Encryption keys
‚îÇ   ‚îî‚îÄ‚îÄ templates/                   # Secret templates
‚îî‚îÄ‚îÄ Scripts/                         # Legacy scripts (to be migrated)
```

## üîÑ Flux GitOps Structure

**Two-level Flux organization:**

1. **Global Templates** (`configs/flux/`):
   - `templates/` - Reusable Flux configuration templates
   - `common-apps/` - Applications used across all clusters
   - `infrastructure/` - Common infrastructure components

2. **Cluster-Specific** (`clusters/{env}/flux/`):
   - `bootstrap/` - Flux bootstrap configuration for this specific cluster
   - `apps/` - Applications deployed only to this cluster
   - `infrastructure/` - Infrastructure specific to this cluster
   - `monitoring/` - Monitoring stack for this cluster

**How it works:**
- Each cluster's Flux points to this repository
- Global templates provide reusable components
- Cluster-specific folders contain what actually gets deployed
- Flux watches the cluster-specific folders for changes

## üöÄ Quick Start

### Prerequisites

- Proxmox VE cluster
- Terraform >= 1.0
- Ansible >= 2.9
- Talos Linux ISO
- Flux CLI

### Getting Started

1. **Configure Proxmox Nodes**
   ```bash
   # Navigate to the setup script (from repository root)
   cd scripts/proxmox/setup/
   
   # Configure PVE02 with custom answer file
   ./setup-unatend-proxmox.sh \
       --distro proxmox \
       --answer-file ../../infrastructure/proxmox/nodes/pve02/unattend_pve02.toml \
       --out /path/to/output/unattended-pve02.iso
   ```

2. **Initialize Terraform**
   ```bash
   cd infrastructure/terraform/environments/dev
   terraform init
   terraform plan
   ```

3. **Bootstrap Talos Cluster**
   ```bash
   cd clusters/dev/talos
   # Configure Talos cluster
   ```

4. **Install Flux**
   ```bash
   cd clusters/dev/flux/bootstrap
   # Bootstrap Flux
   ```

## üìã Configuration Management

- **Proxmox Configs**: Node-specific configurations in `infrastructure/proxmox/nodes/`
- **Terraform Modules**: Reusable modules in `infrastructure/terraform/modules/`
- **Cluster Configs**: Environment-based configurations
- **Scripts**: Organized by functionality in `scripts/`

## üîê Security

- All secrets are encrypted using SOPS
- Encryption keys stored in `secrets/keys/`
- Encrypted secrets in `secrets/encrypted/`
- Access control via Git repository permissions

## üìä Monitoring

- Prometheus + Grafana stack
- Cluster health monitoring
- Infrastructure monitoring
- Application monitoring

## üîÑ GitOps Workflow

1. **Infrastructure Changes**: Terraform ‚Üí Proxmox
2. **Cluster Provisioning**: Terraform ‚Üí Talos
3. **Application Deployment**: Flux ‚Üí Kubernetes
4. **Configuration Management**: Ansible ‚Üí All nodes

## üìö Documentation

- [Architecture](docs/architecture/)
- [Deployment Guide](docs/deployment/)
- [Operations](docs/operations/)
- [Troubleshooting](docs/troubleshooting/)

## ü§ù Contributing

1. Create feature branch
2. Make changes
3. Test thoroughly
4. Submit pull request
5. Review and merge

## üìÑ License

[Add your license here]
